<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Slitherlink</title>

    <link rel="icon" type="image/x-icon" href="images/favicon.png">

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/slitherlink.css">

    <script src="js/bootstrap.js"></script>
    <script src="js/sat.js"></script>

    <script src="js/utilities/utils.js"></script>
    <script src="js/utilities/event-emitter.js"></script>

    <script src="js/grid/grid.js"></script>
    <script src="js/grid/grid-renderer.js"></script>
    <script src="js/grid/square-grid.js"></script>
    <script src="js/grid/honeycomb-grid.js"></script>

    <script src="js/games/game.js"></script>
    <script src="js/games/commons/loop-gen.js"></script>
    <script src="js/games/slitherlink/slitherlink.js"></script>
    <script src="js/games/debug-game.js"></script>
    <script src="js/games/game-generation-progress-renderer.js"></script>

    <script src="js/themes.js"></script>
</head>
<body>

<div class="container">
    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Slitherlink</span>
            <p id = "timebox" class="text-primary mb-0">00:00</p>
        </div>
    </nav>

    <div class="row text-center">

        <div class="col text-center">
            <div class="row text-center mt-2 mb-2">
                <div class="btn-toolbar" role="toolbar">
                    <div class="input-group me-2">
                        <span class="input-group-text">Type</span>
                        <select id = "gridTypeInput" class="form-select" aria-label="Type">
                            <option value="hc" selected>Honeycomb</option>
                            <option value="sq">Squares</option>
                        </select>
                    </div>

                    <div class="input-group me-2">
                        <span  class="input-group-text">Difficulty</span>
                        <select id = "difficultyInput" class="form-select" aria-label="Difficulty">
                            <option value="0">Easy</option>
                            <option value="1">Normal</option>
                            <option value="2" selected>Hard</option>
                            <option value="3">Expert</option>
                            <option value="4">Insane</option>
                        </select>
                    </div>

                    <div class="input-group me-2">
                        <span class="input-group-text">Size</span>
                        <select id = "sizeInput" class="form-select " aria-label="Size">
                            <option value="0">Tiny</option>
                            <option value="1" selected>Small</option>
                            <option value="2">Large</option>
                            <option value="3">Huge</option>
                        </select>
                    </div>

                    <div class="btn-group ms-auto" role="group">
                        <button id = "newGameButton" type="button" class="btn btn-outline-light">New</button>
                    </div>
                </div>
            </div>

            <div class="row text-center">
                <canvas id="canvas"></canvas>
            </div>

            <div class="row text-center mt-2">
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group me-2" role="group">
                        <button id = "undoButton" type="button" class="btn btn-outline-light">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-left" viewBox="0 0 16 16">
                                <path d="M10 12.796V3.204L4.519 8zm-.659.753-5.48-4.796a1 1 0 0 1 0-1.506l5.48-4.796A1 1 0 0 1 11 3.204v9.592a1 1 0 0 1-1.659.753"/>
                            </svg>
                        </button>
                        <button id = "redoButton" type="button" class="btn btn-outline-light">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-right" viewBox="0 0 16 16">
                                <path d="M6 12.796V3.204L11.481 8zm.659.753 5.48-4.796a1 1 0 0 0 0-1.506L6.66 2.451C6.011 1.885 5 2.345 5 3.204v9.592a1 1 0 0 0 1.659.753"/>
                            </svg>
                        </button>
                    </div>
                    <div class="btn-group ms-auto" role="group">
                        <select id = "themeInput" class="form-select" aria-label="Theme">
                            <option value="DEFAULT" selected>Default</option>
                            <option value="CLEAN_CLASSIC">Clean Classic</option>
                            <option value="DARK_NEON">Dark Neon</option>
                            <option value="ANCIENT_PAPER">Ancient Paper</option>
                            <option value="SOFT_PASTEL">Soft Pastel</option>
                            <option value="ICE_TECH">Ice Tech</option>
                            <option value="HIGH_CONTRAST_ARCADE">High Contrast Arcade</option>
                            <option value="ELEGANT_GOLD">Elegant Gold</option>
                        </select>
                    </div>
                    <div class="btn-group ms-auto" role="group">
                        <button id = "restartButton" type="button" class="btn btn-outline-light">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id = "progressModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generating new game</h5>
            </div>
            <div class="modal-body">
                <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" style="width: 30%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const debug = false;
    let theme, grid, game, renderer, progressRenderer;
    let startGameTime;
    let playing = false;

    const timebox = document.getElementById("timebox");

    const gridTypeInput = document.getElementById("gridTypeInput");
    const sizeInput = document.getElementById("sizeInput");
    const difficultyInput = document.getElementById("difficultyInput");
    const newGameButton = document.getElementById("newGameButton");

    const undoButton = document.getElementById("undoButton");
    const redoButton = document.getElementById("redoButton");
    const themeInput = document.getElementById("themeInput");
    const restartButton = document.getElementById("restartButton");

    const canvas = document.getElementById("canvas");

    const hcSizes = [3, 5, 7, 15];
    const sqSizes = [[5, 5], [10, 10], [15, 15], [25, 25]];

    const gridFactories = {
        hc : (size) => new HoneycombGrid(hcSizes[size]),
        sq : (size) => new SquareGrid(sqSizes[size][0], sqSizes[size][1])
    };

    const renderSize = {
        hc: 50,
        sq: 50
    }

    newGameButton.addEventListener("click", () => {
       newGame();
    });

    themeInput.addEventListener("change", () => {
        theme = Themes[themeInput.value];
        renderer.draw(theme);
    })

    restartButton.addEventListener("click", () => {
       game.restart();
       renderer.draw(theme);
       setUndoRedoDisabledState();
    });

    undoButton.addEventListener("click", () => {
        game.undo();
        renderer.draw(theme);
        setUndoRedoDisabledState();
    });

    redoButton.addEventListener("click", () => {
        game.redo();
        renderer.draw(theme);
        setUndoRedoDisabledState();
    });

    newGame();

    function newGame() {
        newGameButton.disabled = true;
        playing = false;

        theme = Themes[themeInput.value];
        grid = gridFactories[gridTypeInput.value](sizeInput.value);
        game = new SlitherLink(grid, difficultyInput.value);

        progressRenderer = new GameGenerationProgressRenderer(grid, canvas, renderSize[gridTypeInput.value]);
        progressRenderer.draw(theme, 0);

        renderer = new GridRenderer(grid, canvas, renderSize[gridTypeInput.value]);
        renderer.debug = debug;

        renderer.on("dotClicked", dot => {
            game.onDotClick(dot);
            renderer.draw(theme);
            setUndoRedoDisabledState();
        });

        renderer.on("edgeClicked", edge => {
            game.onEdgeClick(edge);
            renderer.draw(theme);
            setUndoRedoDisabledState();
        });

        renderer.on("faceClicked", face => {
            game.onFaceClick(face);
            renderer.draw(theme);
            setUndoRedoDisabledState();
        });

        game.on("generate-progress", (progress) => {
            progressRenderer.draw(theme, progress);
        });

        game.on("generate-end", () => {
            newGameButton.disabled = false;
            playing = true;
            startGameTime = Date.now();
            setTimeout(function timer() {
                const millis = Date.now() - startGameTime;

                const seconds = Math.floor((millis / 1000) % 60)
                const minutes = Math.floor((millis / 1000) / 60);

                timebox.innerText = `${minutes < 10 ? '0' + minutes : minutes}:${seconds < 10 ? '0' + seconds : seconds}`;

                if (playing) {
                    setTimeout(timer, 1000);
                }
            }, 1000);
            renderer.draw(theme);
        });

        game.on("finish", () => {
            playing = false;
            renderer.finished = true;
            renderer.draw(theme);
        });

        setUndoRedoDisabledState();
    }

    function setUndoRedoDisabledState() {
        undoButton.disabled = !game.canUndo();
        redoButton.disabled = !game.canRedo();
    }
</script>

</body>
</html>
